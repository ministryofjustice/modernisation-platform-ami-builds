---
name: jumpserver_2019
description: Jumpserver provisioner component.
schemaVersion: 1.0
parameters:
  - Version:
      type: string
      default: 1.0.5
      description: Component version (update this each time the file changes)
  - Platform:
      type: string
      default: "Windows"
      description: Platform.
phases:
  - name: build
    steps:
      - name: ConfigureJava
        action: ExecutePowerShell
        inputs:
          commands:
            - |
              $S3_BUCKET = "ec2-image-builder-nomis20220314103938567000000001"

              # Download/Install Java
              Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/jre-6u33-windows-i586.exe -File C:\jumpserver-software\jre-6u33-windows-i586.exe
              Start-Process -Wait -FilePath "C:\jumpserver-software\jre-6u33-windows-i586.exe" -ArgumentList "/qn", "/s", "/v" -PassThru -RedirectStandardOutput "C:\jumpserver-software\jre-install.log"

              # Copy deployment config files
              $deployment_folder = "C:\Windows\Sun\Java\Deployment"
              New-Item -Path $deployment_folder -ItemType Directory -Force
              Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/deployment.config -File $deployment_folder\deployment.config
              Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/deployment.properties -File $deployment_folder\deployment.properties
              Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/trusted.certs -File $deployment_folder\trusted.certs

              # Prevent Java update check
              Remove-ItemProperty -Path "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run" -Name SunJavaUpdateSched -Force -ErrorAction SilentlyContinue
      - name: ConfigureTrustedSites
        action: ExecutePowerShell
        inputs:
          commands:
            - |
              # Add Nomis sites to trusted sites
              $sites = @(
                  "*.nomis.hmpps-development.modernisation-platform.justice.gov.uk"
                  "*.nomis.hmpps-test.modernisation-platform.justice.gov.uk"
                  "*.nomis.hmpps-preproduction.modernisation-platform.justice.gov.uk"
                  "*.nomis.hmpps-production.modernisation-platform.justice.gov.uk"
                  "*.nomis.service.justice.gov.uk"
                  "*.nomis.az.justice.gov.uk"
                  "*.hmpp-azdt.justice.gov.uk"
              )

              $paths = @(
                  "HKLM:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains"
                  "HKLM:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\EscDomains"
              )

              foreach($path in $paths){
                $sites | ForEach-Object {
                    New-Item -Path $path\$_ -Force
                    New-ItemProperty -Path $path\$_ -Name http -Value 2 -PropertyType DWORD -Force
                    New-ItemProperty -Path $path\$_ -Name https -Value 2 -PropertyType DWORD -Force
                }
              }

              # Use Local Machine settings for Internet Security Settings
              $reg_path = "HKLM:\Software\Policies\Microsoft\Windows\CurrentVersion\Internet Settings"
              New-Item -Path $reg_path -Force
              New-ItemProperty -Path $reg_path -Name Security_HKLM_only -Value 1 -PropertyType DWORD -Force
      - name: ConfigureEdge
        action: ExecutePowerShell
        inputs:
          commands:
            - |
              # Turn off Edge first run experience
              $reg_path = "HKLM:\SOFTWARE\Policies\Microsoft\Edge"
              New-Item -Path $reg_path -Force
              New-ItemProperty -Path $reg_path -Name HideFirstRunExperience -Value 1 -PropertyType DWORD -Force

              # Turn on Edge IE Mode using reg_path from previous step
              New-ItemProperty -Path $reg_path -Name InternetExplorerIntegrationLevel -Value 1 -PropertyType DWORD -Force

              $compatibility_site_list = @(
                  "t1-nomis-web-a.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "t1-nomis-web-a.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "t1-nomis-web-b.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "t1-nomis-web-b.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "t1-cn.hmpp-azdt.justice.gov.uk:7777/forms/frmservlet?config=tag"
                  "t1-cn.hmpp-azdt.justice.gov.uk/forms/frmservlet?config=tag"
                  "c-t1.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c-t1.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "t2-nomis-web-a.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "t2-nomis-web-a.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "t2-nomis-web-b.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "t2-nomis-web-b.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "t2-cn.hmpp-azdt.justice.gov.uk/forms/frmservlet?config=tag"
                  "c-t2.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c-t2.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "t3-nomis-web-a.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "t3-nomis-web-a.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "t3-nomis-web-b.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "t3-nomis-web-b.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "t3-cn.hmpp-azdt.justice.gov.uk/forms/frmservlet?config=tag"
                  "t3-cn-ha.hmpp-azdt.justice.gov.uk/forms/frmservlet?config=tag"
                  "c-t3.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c-t3.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "preprod-nomis-web-a.preproduction.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "preprod-nomis-web-a.preproduction.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "preprod-nomis-web-b.preproduction.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "preprod-nomis-web-b.preproduction.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c.pp-nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c.preproduction.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c.preproduction.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "prod-nomis-web-a.production.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "prod-nomis-web-a.production.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "prod-nomis-web-b.production.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "prod-nomis-web-b.production.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c.production.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
                  "c.production.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
                  "c.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              )

              # Add sites to Edge IE Mode compatibility list
              $compatibility_site_list_path = "C:\\compatibility_site_list.xml"

              $xmlDoc = New-Object System.Xml.XmlDocument
              $root = $xmlDoc.CreateElement("site-list")
              $root.SetAttribute('version', 1)
              $xmlDoc.AppendChild($root)

              $created_byElement = $xmlDoc.CreateElement("created-by")

              $toolElement = $xmlDoc.CreateElement("tool")
              $versionElement = $xmlDoc.CreateElement("version")
              $date_createdElement = $xmlDoc.CreateElement("date_created")
              $toolElement.InnerText = "EMIESiteListManager"
              $versionElement.InnerText = "10.0.0.0"
              $date_createdElement.InnerText = $(Get-Date -Format "MM/dd/yyyy hh:mm:ss")
              $created_byElement.AppendChild($toolElement)
              $created_byElement.AppendChild($versionElement)
              $created_byElement.AppendChild($date_createdElement)
              $root.AppendChild($created_byElement)

              foreach ($site in $compatibility_site_list) {
                $siteElement = $xmlDoc.CreateElement("site")
                $siteElement.SetAttribute('url', $site)
                $compatModeElement = $xmlDoc.CreateElement("compat-mode")
                $openInElement = $xmlDoc.CreateElement("open-in")
                $compatModeElement.InnerText = "Default"
                $openInElement.InnerText = "IE11"
                $siteElement.AppendChild($compatModeElement)
                $siteElement.AppendChild($openInElement)
                $root.AppendChild($siteElement)
              }

              $xmlDoc.Save($compatibility_site_list_path)

              # Add compatibility list to registry
              New-ItemProperty -Path $reg_path -Name InternetExplorerIntegrationSiteList -Value $compatibility_site_list_path -PropertyType String -Force

              # Allow popups for .justice.gov.uk urls
              $reg_path = "HKLM:\SOFTWARE\Policies\Microsoft\Edge\PopupsAllowedForUrls"
              New-Item -Path $reg_path -Force
              New-ItemProperty -Path $reg_path -Name 1 -Value "[*.]justice.gov.uk" -PropertyType String -Force
      - name: ConfigureDesktopShortcut
        action: ExecutePowerShell
        inputs:
          commands:
            - |
              # Create Desktop Shortcut to Nomis
              $new_object = New-Object -ComObject WScript.Shell
              $destination = $new_object.SpecialFolders.Item("AllUsersDesktop")
              $source_path = Join-Path -Path $destination -ChildPath "\\C-Nomis.url"
              $source = $new_object.CreateShortcut($source_path)
              $source.TargetPath = "https://c-t1.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              $source.Save()
      - name: ConfigureSQLDeveloper
        action: ExecutePowerShell
        inputs:
          commands:
            - |
              $S3_BUCKET = "ec2-image-builder-nomis20220314103938567000000001"

              # Download SQL Developer
              Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/sqldeveloper-22.2.1.234.1810-x64.zip -File C:\jumpserver-software\sqldeveloper-22.2.1.234.1810-x64.zip

              # Extract SQL Developer - there is no installer for this application
              Expand-Archive -Path C:\jumpserver-software\sqldeveloper-22.2.1.234.1810-x64.zip -DestinationPath "C:\Program Files\Oracle"

              # Create a desktop shortcut
              $shortcut = New-Object -ComObject WScript.Shell
              $shortcut_link = $shortcut.CreateShortcut("C:\Users\Public\Desktop\SQL Developer.lnk")
              $shortcut_link.TargetPath = "C:\Program Files\Oracle\sqldeveloper\sqldeveloper.exe"
              $shortcut_link.Save()
      - name: InstallLibreOffice
        actions: ExecutePowerShell
        inputs:
          commands:
            - |
              choco install -y libreoffice-still
