---
name: Jumpserver
description: Jumpserver provisioner component.
schemaVersion: 1.0
parameters:
  - Version:
      type: string
      default: "1.1.2"
      description: Component version (update this each time the file changes)
  - Platform:
      type: string
      default: "Windows"
      description: Platform.
phases:
  - name: build
    steps:
    - name: ConfigureJava
      action: ExecutePowerShell
      inputs:
        commands: 
          - |
            # Download files
            $s3bucket = "ec2-image-builder-nomis20220314103938567000000001"
            $s3prefix = "jumpserver-software"
            $download_folder = "C:\jumpserver-software"

            Read-S3Object -BucketName $s3bucket -KeyPrefix $s3prefix -Folder $download_folder

            # Install Java
            Start-Process -Wait -FilePath $download_folder\jre-6u33-windows-i586.exe -ArgumentList "/qn", "/s", "/v" -PassThru -RedirectStandardOutput "$download_folder\jre-install.log"

            # Set Java Deployment files
            $deployment_folder = "C:\Windows\Sun\Java\Deployment"
            New-Item -Path $deployment_folder -ItemType Directory -Force 
            Move-Item -Path $download_folder\java-deployment-config\* -Destination $deployment_folder -Force

            # Prevent Java update check
            Remove-ItemProperty -Path "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run" -Name SunJavaUpdateSched -Force
    - name: ConfigureTrustedSites
      action: ExecutePowerShell
      inputs:
        commands: 
          - |    
            # Add Nomis sites to trusted sites
            $sites = @(
                "*.nomis.hmpps-test.modernisation-platform.internal"
                "*.nomis.hmpps-test.modernisation-platform.justice.gov.uk"
                "*.nomis.hmpps-production.modernisation-platform.internal"
                "*.nomis.hmpps-production.modernisation-platform.justice.gov.uk"
                "*.modernisation-platform.nomis.az.justice.gov.uk"
            )

            $paths = @(
                "HKLM:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains"
                "HKLM:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\EscDomains"
            )

            foreach($path in $paths){
              $sites | ForEach-Object {
                  New-Item -Path $path\$_ -Force
                  New-ItemProperty -Path $path\$_ -Name http -Value 2 -PropertyType DWORD -Force
                  New-ItemProperty -Path $path\$_ -Name https -Value 2 -PropertyType DWORD -Force
              }
            }

            # Use Local Machine settings for Internet Security Settings
            $reg_path = "HKLM:\Software\Policies\Microsoft\Windows\CurrentVersion\Internet Settings"
            New-Item -Path $reg_path -Force
            New-ItemProperty -Path $reg_path -Name Security_HKLM_only -Value 1 -PropertyType DWORD -Force
    - name: InstallWMIExporter
      action: ExecutePowerShell
      inputs:
        commands: 
          - choco install -y prometheus-windows-exporter.install